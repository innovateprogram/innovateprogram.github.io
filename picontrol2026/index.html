<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Presentation Editor</title>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family: system-ui, Arial;
                margin: 0;
                display: flex;
                height: 100vh;
                background: #f0f2f5;
            }

            .left {
                width: 380px;
                min-width: 320px;
                background: #fff;
                border-right: 1px solid #ddd;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .left-inner {
                overflow-y: auto;
                padding: 14px;
                flex: 1;
            }

            .right {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .tabs-bar {
                background: #fff;
                border-bottom: 2px solid #ddd;
                display: flex;
                align-items: flex-end;
                padding: 0 12px;
                gap: 4px;
                overflow-x: auto;
                white-space: nowrap;
                min-height: 46px;
            }
            .tab {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                border: 1px solid transparent;
                border-bottom: none;
                border-radius: 6px 6px 0 0;
                background: #f0f2f5;
                cursor: pointer;
                font-size: 13px;
                transition: background 0.15s;
                position: relative;
                top: 2px;
                user-select: none;
            }
            .tab:hover {
                background: #e4e8f0;
            }
            .tab.active {
                background: #fff;
                border-color: #ddd;
                font-weight: 600;
            }
            .tab .tab-close {
                color: #999;
                font-size: 16px;
                line-height: 1;
                padding: 0 2px;
                cursor: pointer;
            }
            .tab .tab-close:hover {
                color: #c00;
            }
            .tab-add {
                padding: 6px 10px;
                font-size: 20px;
                cursor: pointer;
                color: #555;
                border-radius: 6px;
                user-select: none;
                margin-bottom: 4px;
            }
            .tab-add:hover {
                background: #e4e8f0;
            }
            .active-badge {
                font-size: 10px;
                background: #1a73e8;
                color: #fff;
                border-radius: 4px;
                padding: 1px 5px;
                margin-left: 4px;
                vertical-align: middle;
            }

            .editor-area {
                flex: 1;
                overflow-y: auto;
                padding: 14px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .card {
                background: #fff;
                border: 1px solid #e0e0e0;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 8px;
            }
            .media-list {
                max-height: 36vh;
                overflow-y: auto;
            }
            .media-item {
                display: flex;
                gap: 8px;
                align-items: flex-start;
                padding: 8px 4px;
                border-bottom: 1px solid #eee;
            }
            .media-item img,
            .media-item video {
                width: 72px;
                height: 48px;
                object-fit: cover;
                border-radius: 4px;
                flex-shrink: 0;
            }
            .media-thumb-yt {
                width: 72px;
                height: 48px;
                border-radius: 4px;
                flex-shrink: 0;
                background: #e00;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: #fff;
            }
            .rename-input {
                font-weight: 600;
                font-size: 13px;
                border: 1px solid transparent;
                background: transparent;
                width: 100%;
                padding: 2px 5px;
                border-radius: 4px;
                cursor: text;
                display: block;
                margin-bottom: 2px;
            }
            .rename-input:hover {
                border-color: #ccc;
            }
            .rename-input:focus {
                background: #f0f4ff;
                border-color: #4a90e2;
                outline: none;
            }

            label {
                display: block;
                margin-top: 8px;
                font-weight: 600;
                font-size: 13px;
            }
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                width: 100%;
                padding: 7px 9px;
                border: 1px solid #ccc;
                border-radius: 5px;
                margin-top: 4px;
                font-size: 13px;
            }
            input:focus,
            select:focus {
                outline: none;
                border-color: #4a90e2;
            }
            button {
                padding: 7px 11px;
                margin-top: 8px;
                border-radius: 5px;
                border: 1px solid #bbb;
                background: #f5f5f5;
                cursor: pointer;
                font-size: 13px;
            }
            button:hover {
                background: #e8e8e8;
            }
            button.primary {
                background: #1a73e8;
                color: #fff;
                border-color: #1a73e8;
            }
            button.primary:hover {
                background: #1558b0;
            }
            button.danger {
                background: #d93025;
                color: #fff;
                border-color: #d93025;
            }
            button.danger:hover {
                background: #a50e0e;
            }
            .small {
                font-size: 12px;
                color: #777;
            }
            .row {
                display: flex;
                gap: 8px;
            }
            .row > * {
                flex: 1;
            }

            #progressWrap {
                display: none;
                margin-top: 10px;
            }
            #progressBar {
                width: 100%;
                height: 14px;
                border-radius: 7px;
                overflow: hidden;
                background: #e0e0e0;
                margin-top: 4px;
            }
            #progressFill {
                height: 100%;
                width: 0%;
                background: linear-gradient(90deg, #4caf50, #81c784);
                border-radius: 7px;
                transition: width 0.2s ease;
            }
            #progressPct {
                font-size: 12px;
                color: #333;
                margin-top: 3px;
                text-align: right;
            }

            .swatch-row {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
                margin-top: 8px;
            }
            .swatch {
                width: 26px;
                height: 26px;
                border-radius: 50%;
                cursor: pointer;
                border: 2px solid transparent;
                transition: border-color 0.15s;
                flex-shrink: 0;
            }
            .swatch.active {
                border-color: #000;
            }

            h3 {
                margin: 12px 0 6px;
                font-size: 14px;
            }
            h2 {
                margin: 0;
                font-size: 16px;
            }
            .section-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 6px;
            }

            .item-card {
                background: #fafafa;
                border: 1px solid #e4e4e4;
                border-radius: 6px;
                padding: 10px;
                margin-bottom: 8px;
            }
            .item-title {
                font-weight: 600;
                font-size: 13px;
            }

            .monitors-list {
                display: flex;
                gap: 6px;
                flex-wrap: wrap;
                margin-top: 6px;
            }
            .monitor-badge {
                background: #eee;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                color: #333;
                border: 1px solid #ddd;
            }

            /* Active monitors table */
            .monitors-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 8px;
            }
            .monitors-table th,
            .monitors-table td {
                border: 1px solid #eee;
                padding: 8px;
                text-align: left;
                font-size: 13px;
            }
            .monitors-table th {
                background: #fafafa;
                font-weight: 600;
            }
        </style>
    </head>
    <body>
        <!-- LEFT: media library -->
        <div class="left">
            <div class="left-inner">
                <h3>Upload media</h3>
                <div class="card">
                    <input id="file" type="file" accept="image/*,video/*" />
                    <label>Display name (optional)</label>
                    <input id="fname" type="text" placeholder="Label for this file" />
                    <label>Add to current presentation after upload?</label>
                    <select id="showNow">
                        <option value="no">No</option>
                        <option value="append">Append</option>
                        <option value="replace">Replace</option>
                    </select>
                    <button id="uploadBtn" class="primary" style="width: 100%">‚¨Ü Upload to Cloudinary</button>
                    <div id="progressWrap">
                        <label>Upload progress</label>
                        <div id="progressBar"><div id="progressFill"></div></div>
                        <div id="progressPct">0%</div>
                    </div>
                    <div id="uploadStatus" class="small" style="margin-top: 6px"></div>
                </div>

                <h3>Add YouTube video</h3>
                <div class="card">
                    <label>YouTube URL or Video ID</label>
                    <input id="ytUrl" type="text" placeholder="https://youtube.com/watch?v=... or xxxxxxxxxxx" />
                    <label>Display name</label>
                    <input id="ytName" type="text" placeholder="e.g. Welcome video" />
                    <div class="row">
                        <div>
                            <label>Start (s)</label>
                            <input id="ytStart" type="number" value="0" min="0" />
                        </div>
                        <div>
                            <label>End (s) optional</label>
                            <input id="ytEnd" type="number" placeholder="auto" min="0" />
                        </div>
                    </div>
                    <button id="ytSaveBtn" class="primary" style="width: 100%; margin-top: 8px">
                        üíæ Save YouTube video
                    </button>
                    <div id="ytStatus" class="small" style="margin-top: 6px"></div>
                </div>

                <h3>Stored media <span class="small">(click name to rename)</span></h3>
                <div class="card media-list" id="mediaList"></div>
            </div>
        </div>

        <!-- RIGHT: multi-presentation editor -->
        <div class="right">
            <div class="tabs-bar" id="tabsBar">
                <div class="tab-add" id="addPresentationBtn" title="New presentation">Ôºã</div>
            </div>

            <div class="editor-area" id="editorArea">
                <div class="section-header">
                    <h2 id="editorTitle">Presentation Editor</h2>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 2px">
                        <button id="setActiveBtn" class="primary" title="Make this the live presentation">
                            ‚ö° Set as Live
                        </button>
                        <button id="refreshViewBtn" title="Hard refresh all view pages">üîÑ Refresh Displays</button>
                        <button id="renamePresentationBtn">‚úè Rename</button>
                        <button id="deletePresentationBtn" class="danger">üóë Delete</button>
                    </div>
                </div>

                <div class="card">
                    <div class="row">
                        <div>
                            <label>Mode</label>
                            <select id="mode">
                                <option value="slideshow">Slideshow</option>
                                <option value="single">Single slide</option>
                            </select>
                        </div>
                        <div>
                            <label>Transition</label>
                            <select id="transition">
                                <option value="fade">Fade</option>
                                <option value="cut">Cut</option>
                            </select>
                        </div>
                        <div>
                            <label>Interval (s)</label>
                            <input id="intervalS" type="number" value="5" min="1" />
                        </div>
                    </div>

                    <label>Overlay text</label>
                    <input id="overlayText" placeholder="e.g. Innovate room closed today!" />

                    <label>Overlay background colour</label>
                    <div class="swatch-row" id="overlayBgSwatches">
                        <div class="swatch" style="background: #cc0000" data-color="#cc0000"></div>
                        <div class="swatch" style="background: #e65c00" data-color="#e65c00"></div>
                        <div class="swatch" style="background: #f0b429" data-color="#f0b429"></div>
                        <div class="swatch" style="background: #1a7f37" data-color="#1a7f37"></div>
                        <div class="swatch" style="background: #1a73e8" data-color="#1a73e8"></div>
                        <div class="swatch" style="background: #6a0dad" data-color="#6a0dad"></div>
                        <div class="swatch" style="background: #00bcd4" data-color="#00bcd4"></div>
                        <div class="swatch" style="background: #212121" data-color="#212121"></div>
                        <div class="swatch" style="background: #fff; border: 1px solid #ccc" data-color="#ffffff"></div>
                    </div>
                    <input
                        id="overlayBgColor"
                        type="color"
                        value="#cc0000"
                        style="margin-top: 6px; height: 30px; cursor: pointer; width: 100%" />

                    <label>Overlay text colour</label>
                    <div class="swatch-row" id="overlayTxtSwatches">
                        <div class="swatch" style="background: #fff; border: 1px solid #ccc" data-color="#ffffff"></div>
                        <div class="swatch" style="background: #000" data-color="#000000"></div>
                        <div class="swatch" style="background: #f0b429" data-color="#f0b429"></div>
                        <div class="swatch" style="background: #ff6b6b" data-color="#ff6b6b"></div>
                    </div>
                    <input
                        id="overlayTxtColor"
                        type="color"
                        value="#ffffff"
                        style="margin-top: 6px; height: 30px; cursor: pointer; width: 100%" />

                    <label><input id="overlayVisible" type="checkbox" /> Overlay visible</label>

                    <div style="margin-top: 10px">
                        <label>Assigned monitors (comma-separated)</label>
                        <input id="monitorAssign" placeholder="e.g. Lobby Screen, Room A, 42" />
                        <div style="display: flex; gap: 8px; margin-top: 8px">
                            <button id="assignMonitorsBtn" class="primary">Assign to monitors</button>
                            <button id="clearMonitorAssignments" style="background: #fff; border-color: #bbb">
                                Clear assignments
                            </button>
                        </div>
                        <div class="monitors-list" id="assignedMonitorsList" style="margin-top: 8px"></div>
                    </div>

                    <div class="row" style="margin-top: 10px">
                        <button id="savePresentation" class="primary">üíæ Save settings</button>
                        <button id="clearPresentation">üóë Clear all slides</button>
                    </div>
                </div>

                <h3>Active monitors</h3>
                <div class="card">
                    <div class="small">Monitors report presence via heartbeat. "Online" if last seen within 15s.</div>
                    <table class="monitors-table" id="monitorsTable">
                        <thead>
                            <tr>
                                <th>Monitor</th>
                                <th>Status</th>
                                <th>Last seen</th>
                                <th>Resolution</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitorsTbody"></tbody>
                    </table>
                </div>

                <h3>Slides <span class="small">‚Äî click Ôºã Add to slide in the media library to add items</span></h3>
                <div id="presentationItems"></div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                push,
                set,
                onValue,
                remove,
                get,
                update
            } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBgV9PoUFut3FPc0iChFNm2-h6-Uc5z6s0",
                authDomain: "infinity-service-b2f10.firebaseapp.com",
                databaseURL: "https://infinity-service-b2f10-default-rtdb.firebaseio.com",
                projectId: "infinity-service-b2f10",
                storageBucket: "infinity-service-b2f10.firebasestorage.app",
                messagingSenderId: "805770674259",
                appId: "1:805770674259:web:bcc520979e6772fda5c6a6"
            };
            const CLOUD_NAME = "dgrmpcha9";
            const UPLOAD_PRESET = "Innovate";

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const mediaRef = ref(db, "media");
            const presentationsRef = ref(db, "presentations");
            const activeRef = ref(db, "activePresentation");
            const refreshRef = ref(db, "refreshSignal");
            const monitorsRef = ref(db, "monitors");

            // DOM
            const fileInput = document.getElementById("file");
            const uploadBtn = document.getElementById("uploadBtn");
            const uploadStatus = document.getElementById("uploadStatus");
            const fname = document.getElementById("fname");
            const showNow = document.getElementById("showNow");
            const progressWrap = document.getElementById("progressWrap");
            const progressFill = document.getElementById("progressFill");
            const progressPct = document.getElementById("progressPct");
            const mediaListEl = document.getElementById("mediaList");
            const presentationItemsEl = document.getElementById("presentationItems");
            const tabsBar = document.getElementById("tabsBar");
            const addPresentationBtn = document.getElementById("addPresentationBtn");
            const editorTitle = document.getElementById("editorTitle");
            const modeEl = document.getElementById("mode");
            const transitionEl = document.getElementById("transition");
            const intervalSEl = document.getElementById("intervalS");
            const overlayTextEl = document.getElementById("overlayText");
            const overlayVisibleEl = document.getElementById("overlayVisible");
            const overlayBgColorInput = document.getElementById("overlayBgColor");
            const overlayTxtColorInput = document.getElementById("overlayTxtColor");
            const savePresentationBtn = document.getElementById("savePresentation");
            const clearPresentationBtn = document.getElementById("clearPresentation");
            const setActiveBtn = document.getElementById("setActiveBtn");
            const refreshViewBtn = document.getElementById("refreshViewBtn");
            const renamePresentationBtn = document.getElementById("renamePresentationBtn");
            const deletePresentationBtn = document.getElementById("deletePresentationBtn");
            const ytUrlEl = document.getElementById("ytUrl");
            const ytNameEl = document.getElementById("ytName");
            const ytStartEl = document.getElementById("ytStart");
            const ytEndEl = document.getElementById("ytEnd");
            const ytSaveBtn = document.getElementById("ytSaveBtn");
            const ytStatus = document.getElementById("ytStatus");
            const monitorAssignInput = document.getElementById("monitorAssign");
            const assignMonitorsBtn = document.getElementById("assignMonitorsBtn");
            const assignedMonitorsList = document.getElementById("assignedMonitorsList");
            const clearMonitorAssignmentsBtn = document.getElementById("clearMonitorAssignments");
            const monitorsTbody = document.getElementById("monitorsTbody");

            // State
            let localMedia = {};
            let presentations = {};
            let activePresentationId = null;
            let selectedPresentationId = null;
            let selectedOverlayBg = "#cc0000";
            let selectedOverlayTxt = "#ffffff";
            let localMonitors = {}; // keyed by encoded monitor name

            // Utility: escape HTML
            function escHtml(s) {
                return s ? String(s).replaceAll("<", "&lt;").replaceAll(">", "&gt;") : "";
            }

            // Swatch helpers
            function setSwatchActive(containerId, color) {
                const cont = document.getElementById(containerId);
                if (!cont) return;
                cont.querySelectorAll(".swatch").forEach((s) => {
                    if ((s.dataset.color || "").toLowerCase() === (color || "").toLowerCase())
                        s.classList.add("active");
                    else s.classList.remove("active");
                });
            }

            function setupSwatches(contId, inputEl, onSelect) {
                const cont = document.getElementById(contId);
                if (!cont) return;
                cont.querySelectorAll(".swatch").forEach((s) => {
                    s.onclick = () => {
                        const color = s.dataset.color || "";
                        // set input value and trigger input event so all listeners save
                        inputEl.value = color;
                        // reflect active state
                        setSwatchActive(contId, color);
                        onSelect(color);
                        // dispatch input event for any other logic
                        inputEl.dispatchEvent(new Event("input", { bubbles: true }));
                    };
                });
                // when user picks a color via the color input, clear swatch active highlights and call onSelect
                inputEl.addEventListener("input", () => {
                    setSwatchActive(contId, inputEl.value);
                    onSelect(inputEl.value);
                });
            }

            setupSwatches("overlayBgSwatches", overlayBgColorInput, (c) => (selectedOverlayBg = c));
            setupSwatches("overlayTxtSwatches", overlayTxtColorInput, (c) => (selectedOverlayTxt = c));

            // Debounce helper for text inputs
            function debounce(fn, wait = 400) {
                let t;
                return (...args) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...args), wait);
                };
            }

            // YouTube ID extractor
            function extractYtId(raw) {
                raw = (raw || "").trim();
                if (/^[a-zA-Z0-9_-]{11}$/.test(raw)) return raw;
                try {
                    const u = new URL(raw);
                    if (u.hostname.includes("youtu.be")) return u.pathname.slice(1).split("?")[0].slice(0, 11);
                    return u.searchParams.get("v") || null;
                } catch {
                    return null;
                }
            }

            ytSaveBtn.onclick = async () => {
                const raw = ytUrlEl.value.trim();
                if (!raw) return alert("Enter a YouTube URL or video ID");
                const videoId = extractYtId(raw);
                if (!videoId)
                    return alert(
                        "Could not parse a YouTube video ID from that URL.\nTry pasting just the 11-character video ID."
                    );
                const name = ytNameEl.value.trim() || `YouTube: ${videoId}`;
                const start = parseFloat(ytStartEl.value) || 0;
                const endVal = ytEndEl.value.trim();
                const end = endVal ? parseFloat(endVal) : null;
                const mobj = {
                    resource_type: "youtube",
                    ytId: videoId,
                    filename: name,
                    uploadedAt: Date.now(),
                    start,
                    end,
                    duration: end || null
                };
                const newRef = push(mediaRef);
                await set(newRef, mobj);
                ytUrlEl.value = "";
                ytNameEl.value = "";
                ytStartEl.value = "0";
                ytEndEl.value = "";
                ytStatus.textContent = "‚úÖ Saved.";
                setTimeout(() => (ytStatus.textContent = ""), 3000);
            };

            // Firebase listeners
            onValue(mediaRef, (snap) => {
                localMedia = snap.val() || {};
                renderMediaList();
                if (selectedPresentationId) renderPresentationEditor();
            });

            onValue(presentationsRef, (snap) => {
                const raw = snap.val() || {};
                presentations = {};
                for (const [k, v] of Object.entries(raw)) {
                    if (k !== "current") presentations[k] = v;
                }
                if (Object.keys(presentations).length === 0) {
                    createPresentation("Main");
                    return;
                }
                if (!selectedPresentationId || !presentations[selectedPresentationId]) {
                    selectedPresentationId = Object.keys(presentations)[0];
                }
                renderTabs();
                renderPresentationEditor();
            });

            onValue(activeRef, (snap) => {
                activePresentationId = snap.val() || null;
                renderTabs();
            });

            // Monitors listener
            onValue(monitorsRef, (snap) => {
                localMonitors = snap.val() || {};
                renderTabs();
                renderMonitorsTable();
                renderPresentationEditor();
            });

            // Create presentation
            async function createPresentation(name) {
                const newRef = push(presentationsRef);
                const id = newRef.key;
                await set(newRef, {
                    name: name || "New Presentation",
                    items: [],
                    mode: "slideshow",
                    intervalMs: 5000,
                    transition: "fade",
                    overlay: { text: "", visible: false, color: "#cc0000", textColor: "#ffffff" }
                });
                selectedPresentationId = id;
            }

            addPresentationBtn.onclick = async () => {
                const name = prompt("New presentation name:", "New Presentation");
                if (name) await createPresentation(name);
            };

            renamePresentationBtn.onclick = async () => {
                if (!selectedPresentationId) return;
                const cur = presentations[selectedPresentationId]?.name || "";
                const name = prompt("Rename presentation:", cur);
                if (!name) return;
                await update(ref(db, `presentations/${selectedPresentationId}`), { name });
            };

            deletePresentationBtn.onclick = async () => {
                if (!selectedPresentationId) return;
                if (Object.keys(presentations).length <= 1) return alert("You need at least one presentation.");
                const name = presentations[selectedPresentationId]?.name;
                if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
                // Remove monitor mappings to this presentation
                const monitorsSnap = await get(monitorsRef);
                const monitorsObj = monitorsSnap.val() || {};
                for (const [mn, pid] of Object.entries(monitorsObj)) {
                    if (pid === selectedPresentationId) {
                        await remove(ref(db, `monitors/${mn}`));
                    }
                }
                await remove(ref(db, `presentations/${selectedPresentationId}`));
                selectedPresentationId = null;
            };

            setActiveBtn.onclick = async () => {
                if (!selectedPresentationId) return;
                await set(activeRef, selectedPresentationId);
                const p = (await get(ref(db, `presentations/${selectedPresentationId}`))).val();
                if (p) await set(ref(db, "presentations/current"), { ...p, id: "current" });
                alert(`"${p?.name}" is now live on the display.`);
            };

            refreshViewBtn.onclick = async () => {
                // global refresh signal (all views listening to refreshSignal will reload)
                await set(refreshRef, Date.now());
            };

            // Render tabs
            function renderTabs() {
                tabsBar.querySelectorAll(".tab").forEach((t) => t.remove());
                const addBtn = document.getElementById("addPresentationBtn");

                // Build reverse mapping: presentationId -> [monitorNames]
                const rev = {};
                for (const [mn, pid] of Object.entries(localMonitors || {})) {
                    if (!pid) continue;
                    rev[pid] = rev[pid] || [];
                    rev[pid].push(decodeURIComponent(mn));
                }

                Object.entries(presentations).forEach(([id, p]) => {
                    const isSelected = id === selectedPresentationId;
                    const isLive = id === activePresentationId;
                    const assigned = rev[id] || [];
                    const tab = document.createElement("div");
                    tab.className = "tab" + (isSelected ? " active" : "");
                    tab.innerHTML = `<span>${escHtml(p.name || "Untitled")}${isLive ? '<span class="active-badge">LIVE</span>' : ""}</span><span class="tab-close" title="Delete">√ó</span>`;
                    if (assigned.length) {
                        const small = document.createElement("div");
                        small.style.fontSize = "11px";
                        small.style.marginTop = "4px";
                        small.style.opacity = "0.8";
                        small.textContent = "Monitors: " + assigned.join(", ");
                        tab.appendChild(small);
                    }
                    tab.addEventListener("click", (e) => {
                        if (e.target.classList.contains("tab-close")) return;
                        selectedPresentationId = id;
                        renderTabs();
                        renderPresentationEditor();
                    });
                    tab.querySelector(".tab-close").addEventListener("click", async (e) => {
                        e.stopPropagation();
                        if (Object.keys(presentations).length <= 1)
                            return alert("Must have at least one presentation.");
                        if (!confirm(`Delete "${p.name}"?`)) return;
                        await remove(ref(db, `presentations/${id}`));
                    });
                    tabsBar.insertBefore(tab, addBtn);
                });
            }

            // Render media library
            function renderMediaList() {
                mediaListEl.innerHTML = "";
                const keys = Object.keys(localMedia).sort(
                    (a, b) => localMedia[a].uploadedAt - localMedia[b].uploadedAt
                );
                for (const id of keys) {
                    const m = localMedia[id];
                    const div = document.createElement("div");
                    div.className = "media-item";
                    let thumb = "";
                    if (m.resource_type === "youtube") thumb = `<div class="media-thumb-yt">‚ñ∂</div>`;
                    else if (m.resource_type === "image") thumb = `<img src="${m.url}" />`;
                    else thumb = `<video src="${m.url}" muted playsinline></video>`;

                    div.innerHTML = `
            ${thumb}
            <div style="flex:1;min-width:0">
                <input class="rename-input" data-id="${id}" value="${escHtml(m.filename || id)}" title="Click to rename" />
                <div class="small">${m.resource_type}${m.resource_type === "youtube" ? " ¬∑ " + m.ytId : ""} ¬∑ ${new Date(m.uploadedAt).toLocaleDateString()}</div>
                <div style="margin-top:5px;display:flex;gap:6px;flex-wrap:wrap">
                    <button data-id="${id}" class="addBtn">Ôºã Add to slide</button>
                    <button data-id="${id}" class="deleteBtn" style="color:#c00;border-color:#fcc">üóë</button>
                </div>
            </div>
        `;
                    mediaListEl.appendChild(div);
                }

                mediaListEl.querySelectorAll(".rename-input").forEach((inp) => {
                    const save = async () => {
                        const id = inp.dataset.id;
                        const val = inp.value.trim();
                        if (!val || val === (localMedia[id]?.filename || "")) return;
                        await update(ref(db, `media/${id}`), { filename: val });
                    };
                    inp.addEventListener("blur", save);
                    inp.addEventListener("keydown", (e) => {
                        if (e.key === "Enter") inp.blur();
                    });
                });

                mediaListEl
                    .querySelectorAll(".addBtn")
                    .forEach((b) => (b.onclick = () => addToPresentation(b.dataset.id)));
                mediaListEl.querySelectorAll(".deleteBtn").forEach((b) => {
                    b.onclick = async () => {
                        if (!confirm("Delete this media permanently from all presentations?")) return;
                        await remove(ref(db, "media/" + b.dataset.id));
                        for (const [pid, p] of Object.entries(presentations)) {
                            if (!p.items) continue;
                            const filtered = p.items.filter((it) => it.mediaId !== b.dataset.id);
                            if (filtered.length !== p.items.length)
                                await update(ref(db, `presentations/${pid}`), { items: filtered });
                        }
                    };
                });
            }

            // Add media item to selected presentation
            async function addToPresentation(mediaId) {
                if (!selectedPresentationId) return alert("Select a presentation tab first");
                const m = localMedia[mediaId];
                if (!m) return;
                const pSnap = await get(ref(db, `presentations/${selectedPresentationId}`));
                const p = pSnap.val() || {};
                const items = p.items || [];
                items.push({ mediaId, start: m.start || 0, end: m.end || m.duration || null, label: m.filename || "" });
                await update(ref(db, `presentations/${selectedPresentationId}`), { items });
            }

            // Helper to update partial presentation fields
            async function updatePresentationPartial(updates) {
                if (!selectedPresentationId) return;
                await update(ref(db, `presentations/${selectedPresentationId}`), updates);
                // If this is the active presentation, also update "presentations/current"
                if (selectedPresentationId === activePresentationId) {
                    const curRef = ref(db, `presentations/current`);
                    const curSnap = await get(curRef);
                    const curVal = curSnap.val() || {};
                    const merged = { ...curVal, ...updates };
                    await set(curRef, merged);
                }
            }

            // Render presentation editor panel
            function renderPresentationEditor() {
                presentationItemsEl.innerHTML = "";
                if (!selectedPresentationId || !presentations[selectedPresentationId]) return;
                const p = presentations[selectedPresentationId];

                editorTitle.textContent = p.name || "Presentation";
                modeEl.value = p.mode || "slideshow";
                transitionEl.value = p.transition || "fade";
                intervalSEl.value = Math.round((p.intervalMs || 5000) / 1000);

                overlayTextEl.value = p.overlay?.text || "";
                overlayVisibleEl.checked = !!p.overlay?.visible;
                if (p.overlay?.color) {
                    selectedOverlayBg = p.overlay.color;
                    overlayBgColorInput.value = p.overlay.color;
                    setSwatchActive("overlayBgSwatches", selectedOverlayBg);
                } else {
                    setSwatchActive("overlayBgSwatches", overlayBgColorInput.value);
                }
                if (p.overlay?.textColor) {
                    selectedOverlayTxt = p.overlay.textColor;
                    overlayTxtColorInput.value = p.overlay.textColor;
                    setSwatchActive("overlayTxtSwatches", selectedOverlayTxt);
                } else {
                    setSwatchActive("overlayTxtSwatches", overlayTxtColorInput.value);
                }

                // Show assigned monitors for this presentation
                assignedMonitorsList.innerHTML = "";
                const assigned = [];
                for (const [mn, pid] of Object.entries(localMonitors || {})) {
                    if (pid === selectedPresentationId) assigned.push(decodeURIComponent(mn));
                }
                assigned.forEach((name) => {
                    const el = document.createElement("div");
                    el.className = "monitor-badge";
                    el.textContent = name;
                    assignedMonitorsList.appendChild(el);
                });

                const pRef = ref(db, `presentations/${selectedPresentationId}`);
                const getP = async () => (await get(pRef)).val();

                (p.items || []).forEach((it, index) => {
                    const m = localMedia[it.mediaId] || {};
                    const isYt = m.resource_type === "youtube";
                    const div = document.createElement("div");
                    div.className = "item-card";
                    div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <span class="item-title">${isYt ? "‚ñ∂ " : ""}${escHtml(m.filename || it.mediaId || "(missing)")}</span>
                <div style="display:flex;gap:4px;flex-shrink:0">
                    <button data-idx="${index}" class="upBtn" style="padding:4px 8px">‚ñ≤</button>
                    <button data-idx="${index}" class="downBtn" style="padding:4px 8px">‚ñº</button>
                    <button data-idx="${index}" class="removeBtn" style="color:#c00;padding:4px 8px">‚úï</button>
                </div>
            </div>
            <div class="small" style="margin:3px 0">${m.resource_type || "?"} ¬∑ mediaId: ${it.mediaId}</div>
            <label>Label</label>
            <input data-idx="${index}" class="itemLabel" value="${escHtml(it.label || "")}" />
            <div class="row">
                <div><label>Start (s)</label><input type="number" data-idx="${index}" class="itemStart" value="${it.start || 0}" /></div>
                <div><label>End (s) ‚Äî blank = auto</label><input type="number" data-idx="${index}" class="itemEnd" value="${it.end == null ? "" : it.end}" /></div>
            </div>
        `;
                    presentationItemsEl.appendChild(div);
                });

                presentationItemsEl.querySelectorAll(".removeBtn").forEach(
                    (b) =>
                        (b.onclick = async () => {
                            const p2 = await getP();
                            p2.items.splice(+b.dataset.idx, 1);
                            await set(pRef, p2);
                        })
                );
                presentationItemsEl.querySelectorAll(".upBtn").forEach(
                    (b) =>
                        (b.onclick = async () => {
                            const p2 = await getP();
                            const i = +b.dataset.idx;
                            if (i <= 0) return;
                            [p2.items[i - 1], p2.items[i]] = [p2.items[i], p2.items[i - 1]];
                            await set(pRef, p2);
                        })
                );
                presentationItemsEl.querySelectorAll(".downBtn").forEach(
                    (b) =>
                        (b.onclick = async () => {
                            const p2 = await getP();
                            const i = +b.dataset.idx;
                            if (i >= p2.items.length - 1) return;
                            [p2.items[i + 1], p2.items[i]] = [p2.items[i], p2.items[i + 1]];
                            await set(pRef, p2);
                        })
                );
                presentationItemsEl.querySelectorAll(".itemStart").forEach(
                    (inp) =>
                        (inp.onchange = async () => {
                            const p2 = await getP();
                            p2.items[+inp.dataset.idx].start = parseFloat(inp.value) || 0;
                            await set(pRef, p2);
                        })
                );
                presentationItemsEl.querySelectorAll(".itemEnd").forEach(
                    (inp) =>
                        (inp.onchange = async () => {
                            const p2 = await getP();
                            const v = inp.value;
                            p2.items[+inp.dataset.idx].end = v === "" ? null : parseFloat(v);
                            await set(pRef, p2);
                        })
                );
                presentationItemsEl.querySelectorAll(".itemLabel").forEach(
                    (inp) =>
                        (inp.onchange = async () => {
                            const p2 = await getP();
                            p2.items[+inp.dataset.idx].label = inp.value;
                            await set(pRef, p2);
                        })
                );
            }

            // Save settings button (keeps for manual save but most settings auto-save now)
            savePresentationBtn.onclick = async () => {
                if (!selectedPresentationId) return;
                const pRef = ref(db, `presentations/${selectedPresentationId}`);
                const cur = (await get(pRef)).val() || {};
                const updated = {
                    ...cur,
                    mode: modeEl.value,
                    transition: transitionEl.value,
                    intervalMs: (parseInt(intervalSEl.value, 10) || 5) * 1000,
                    overlay: {
                        text: overlayTextEl.value,
                        visible: !!overlayVisibleEl.checked,
                        color: selectedOverlayBg,
                        textColor: selectedOverlayTxt
                    }
                };
                await set(pRef, updated);
                if (selectedPresentationId === activePresentationId) {
                    await set(ref(db, "presentations/current"), { ...updated, id: "current" });
                }
                alert("Settings saved.");
            };

            clearPresentationBtn.onclick = async () => {
                if (!confirm("Remove all slides from this presentation?")) return;
                await update(ref(db, `presentations/${selectedPresentationId}`), { items: [] });
            };

            // Monitor assignment logic
            assignMonitorsBtn.onclick = async () => {
                if (!selectedPresentationId) return alert("Select a presentation first.");
                const raw = monitorAssignInput.value.trim();
                const names = raw
                    ? raw
                          .split(",")
                          .map((s) => s.trim())
                          .filter(Boolean)
                    : [];
                const keys = names.map((n) => encodeURIComponent(n));
                const snap = await get(monitorsRef);
                const cur = snap.val() || {};

                // Remove assignments for this presentation that are not in new list
                for (const [mn, pid] of Object.entries(cur)) {
                    if (pid === selectedPresentationId && !keys.includes(mn)) {
                        await remove(ref(db, `monitors/${mn}`));
                    }
                }
                // Assign new names to this presentation
                for (const k of keys) {
                    await set(ref(db, `monitors/${k}`), selectedPresentationId);
                }
                monitorAssignInput.value = "";
                alert("Monitor assignments updated.");
            };

            clearMonitorAssignmentsBtn.onclick = async () => {
                if (!selectedPresentationId) return;
                if (!confirm("Clear all monitor assignments that point to this presentation?")) return;
                const snap = await get(monitorsRef);
                const cur = snap.val() || {};
                for (const [mn, pid] of Object.entries(cur)) {
                    if (pid === selectedPresentationId) {
                        await remove(ref(db, `monitors/${mn}`));
                    }
                }
                alert("Cleared.");
            };

            // Render monitors table
            function renderMonitorsTable() {
                monitorsTbody.innerHTML = "";
                const rows = Object.entries(localMonitors || {}).sort((a, b) => a[0].localeCompare(b[0]));
                const now = Date.now();
                for (const [encodedName, data] of rows) {
                    const name = decodeURIComponent(encodedName);
                    const tr = document.createElement("tr");
                    const lastSeen = data && data.lastSeen ? data.lastSeen : 0;
                    const online = now - lastSeen < 15000 && data && data.status === "online";
                    tr.innerHTML = `
          <td>${escHtml(name)}</td>
          <td>${online ? '<strong style="color:green">online</strong>' : '<span style="color:#777">offline</span>'}</td>
          <td>${lastSeen ? new Date(lastSeen).toLocaleString() : "‚Äî"}</td>
          <td>${data && data.resolution ? escHtml(data.resolution) : "‚Äî"}</td>
          <td>
            <button data-name="${encodedName}" class="assignToBtn">Assign</button>
            <button data-name="${encodedName}" class="refreshBtn">Reload</button>
            <button data-name="${encodedName}" class="removeBtn" style="color:#c00">Remove</button>
          </td>
        `;
                    monitorsTbody.appendChild(tr);
                }

                // actions
                monitorsTbody.querySelectorAll(".assignToBtn").forEach((b) => {
                    b.onclick = () => {
                        const name = decodeURIComponent(b.dataset.name);
                        monitorAssignInput.value =
                            (monitorAssignInput.value ? monitorAssignInput.value + ", " : "") + name;
                    };
                });
                monitorsTbody.querySelectorAll(".refreshBtn").forEach((b) => {
                    b.onclick = async () => {
                        const key = b.dataset.name;
                        await set(ref(db, `monitors/${key}/command`), { cmd: "reloadPresentation", at: Date.now() });
                        alert("Reload command sent to " + decodeURIComponent(key));
                    };
                });
                monitorsTbody.querySelectorAll(".removeBtn").forEach((b) => {
                    b.onclick = async () => {
                        if (!confirm("Remove monitor entry (this unmaps it and marks offline)?")) return;
                        await remove(ref(db, `monitors/${b.dataset.name}`));
                    };
                });
            }

            // Upload
            uploadBtn.onclick = async () => {
                const file = fileInput.files[0];
                if (!file) return alert("Choose a file first");
                uploadStatus.textContent = "";
                progressWrap.style.display = "block";
                progressFill.style.width = "0%";
                progressPct.textContent = "0%";
                uploadBtn.disabled = true;
                try {
                    const fd = new FormData();
                    fd.append("file", file);
                    fd.append("upload_preset", UPLOAD_PRESET);
                    const data = await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open("POST", `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`);
                        xhr.upload.onprogress = (e) => {
                            if (e.lengthComputable) {
                                const pct = Math.round((e.loaded / e.total) * 100);
                                progressFill.style.width = pct + "%";
                                progressPct.textContent = pct + "%";
                            }
                        };
                        xhr.onload = () =>
                            xhr.status < 300
                                ? resolve(JSON.parse(xhr.responseText))
                                : reject(new Error("HTTP " + xhr.status));
                        xhr.onerror = () => reject(new Error("Network error"));
                        xhr.send(fd);
                    });
                    progressFill.style.width = "100%";
                    progressPct.textContent = "100%";
                    const mobj = {
                        url: data.secure_url,
                        resource_type: data.resource_type,
                        filename: fname.value || file.name,
                        uploadedAt: Date.now(),
                        duration: data.duration || null
                    };
                    const newRef = push(mediaRef);
                    await set(newRef, mobj);
                    uploadStatus.textContent = "‚úÖ Uploaded and saved.";
                    fname.value = "";
                    fileInput.value = "";
                    if (showNow.value !== "no" && selectedPresentationId) {
                        const pRef = ref(db, `presentations/${selectedPresentationId}`);
                        const cur = (await get(pRef)).val() || {};
                        const item = {
                            mediaId: newRef.key,
                            start: 0,
                            end: mobj.duration || null,
                            label: mobj.filename
                        };
                        await update(pRef, {
                            items: showNow.value === "replace" ? [item] : [...(cur.items || []), item]
                        });
                    }
                } catch (err) {
                    console.error(err);
                    uploadStatus.textContent = "‚ùå Failed: " + err.message;
                } finally {
                    uploadBtn.disabled = false;
                    setTimeout(() => {
                        progressWrap.style.display = "none";
                    }, 3000);
                }
            };

            // Auto-save listeners for editor fields (so changes don't "revert" while editing)
            modeEl.addEventListener("change", async () => {
                await updatePresentationPartial({ mode: modeEl.value });
            });
            transitionEl.addEventListener("change", async () => {
                await updatePresentationPartial({ transition: transitionEl.value });
            });
            intervalSEl.addEventListener("change", async () => {
                const ms = (parseInt(intervalSEl.value, 10) || 5) * 1000;
                await updatePresentationPartial({ intervalMs: ms });
            });

            // overlay fields - debounce text
            const saveOverlayText = debounce(async () => {
                await updatePresentationPartial({
                    overlay: { ...(presentations[selectedPresentationId]?.overlay || {}), text: overlayTextEl.value }
                });
            }, 400);
            overlayTextEl.addEventListener("input", saveOverlayText);

            overlayVisibleEl.addEventListener("change", async () => {
                await updatePresentationPartial({
                    overlay: {
                        ...(presentations[selectedPresentationId]?.overlay || {}),
                        visible: !!overlayVisibleEl.checked
                    }
                });
            });

            overlayBgColorInput.addEventListener("input", async () => {
                selectedOverlayBg = overlayBgColorInput.value;
                setSwatchActive("overlayBgSwatches", selectedOverlayBg);
                await updatePresentationPartial({
                    overlay: { ...(presentations[selectedPresentationId]?.overlay || {}), color: selectedOverlayBg }
                });
            });

            overlayTxtColorInput.addEventListener("input", async () => {
                selectedOverlayTxt = overlayTxtColorInput.value;
                setSwatchActive("overlayTxtSwatches", selectedOverlayTxt);
                await updatePresentationPartial({
                    overlay: {
                        ...(presentations[selectedPresentationId]?.overlay || {}),
                        textColor: selectedOverlayTxt
                    }
                });
            });

            // Render initial swatch active states on load
            document.addEventListener("DOMContentLoaded", () => {
                setSwatchActive("overlayBgSwatches", overlayBgColorInput.value);
                setSwatchActive("overlayTxtSwatches", overlayTxtColorInput.value);
            });
        </script>
    </body>
</html>
