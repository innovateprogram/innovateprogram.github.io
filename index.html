<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Fullscreen View</title>
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                background: #000;
                color: #fff;
                font-family: system-ui, Arial;
                cursor: none; /* hide cursor */
            }

            .p {
                color: #fff;
            }
            #root {
                position: fixed;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }
            .canvas {
                position: relative;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #000;
            }
            .slide {
                position: absolute;
                inset: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: opacity 800ms ease;
                opacity: 0;
                pointer-events: none;
            }
            .slide.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .slide img,
            .slide video {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            /* Overlay - solid top-left banner sliding in from left */
            @keyframes bannerIn {
                from {
                    transform: translateX(-110%);
                }
                to {
                    transform: translateX(0);
                }
            }
            .overlay {
                position: absolute;
                top: 0;
                left: 0;
                padding: 18px 40px 18px 28px;
                border-radius: 0 0 12px 0;
                font-size: 28px;
                font-weight: 800;
                letter-spacing: 0.03em;
                line-height: 1.3;
                z-index: 100;
                max-width: 80vw;
                word-break: break-word;
                box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.35);
                animation: bannerIn 0.55s cubic-bezier(0.22, 1, 0.36, 1) both;
                /* background and color set dynamically via JS */
            }
        </style>
    </head>
    <body>
        <div id="root">
            <div class="canvas" id="canvas"></div>
            <div class="overlay" id="overlay" style="display: none"></div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
            import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBgV9PoUFut3FPc0iChFNm2-h6-Uc5z6s0",
                authDomain: "infinity-service-b2f10.firebaseapp.com",
                databaseURL: "https://infinity-service-b2f10-default-rtdb.firebaseio.com",
                projectId: "infinity-service-b2f10",
                storageBucket: "infinity-service-b2f10.firebasestorage.app",
                messagingSenderId: "805770674259",
                appId: "1:805770674259:web:bcc520979e6772fda5c6a6"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const mediaRef = ref(db, "media");
            const presentationRef = ref(db, "presentations/current");

            const canvas = document.getElementById("canvas");
            const overlayEl = document.getElementById("overlay");

            let mediaCache = {};
            let presentation = null;
            let slideIndex = 0;
            let slideTimer = null;
            let currentSlideEl = null;

            onValue(mediaRef, (snap) => {
                mediaCache = snap.val() || {};
                if (presentation) renderPresentation(presentation);
            });

            onValue(presentationRef, (snap) => {
                presentation = snap.val() || { items: [] };
                renderPresentation(presentation);
            });

            function renderPresentation(p) {
                clearTimeout(slideTimer);
                slideTimer = null;
                slideIndex = 0;

                // Pause any playing videos before clearing
                canvas.querySelectorAll("video").forEach((v) => v.pause());
                canvas.innerHTML = "";

                if (!p || !p.items || p.items.length === 0) {
                    overlayEl.style.display = "none";
                    return;
                }

                // Overlay styling — always fully solid, no transparency
                const overlayColor = (p.overlay && p.overlay.color) || "#cc0000";
                const overlayTextColor = (p.overlay && p.overlay.textColor) || "#ffffff";
                overlayEl.style.background = overlayColor;
                overlayEl.style.color = overlayTextColor;
                overlayEl.textContent = (p.overlay && p.overlay.text) || "";

                const overlayVisible = p.overlay && p.overlay.visible;
                if (overlayVisible) {
                    overlayEl.style.display = "block";
                    overlayEl.style.animation = "none";
                    void overlayEl.offsetWidth;
                    overlayEl.style.animation = "";
                } else {
                    overlayEl.style.display = "none";
                }

                // Create slide elements
                p.items.forEach((it, idx) => {
                    const m = mediaCache[it.mediaId];
                    const slide = document.createElement("div");
                    slide.className = "slide";
                    slide.dataset.idx = idx;
                    slide.dataset.mediaId = it.mediaId;

                    if (!m) {
                        slide.innerHTML = `<div style="color:#fff;font-size:24px">Missing media: ${it.mediaId}</div>`;
                    } else if (m.resource_type === "image") {
                        const img = document.createElement("img");
                        img.src = m.url;
                        slide.appendChild(img);
                    } else {
                        const vid = document.createElement("video");
                        vid.src = m.url;
                        vid.setAttribute("playsinline", "");
                        vid.preload = "auto";
                        vid.controls = false;
                        vid.style.maxWidth = "100%";
                        vid.style.maxHeight = "100%";
                        slide.appendChild(vid);
                    }
                    canvas.appendChild(slide);
                });

                slideIndex = 0;
                showSlideAtIndex(p, 0);
            }

            function showSlideAtIndex(p, idx) {
                clearTimeout(slideTimer);
                slideTimer = null;

                if (!p.items || p.items.length === 0) return;
                if (idx >= p.items.length) idx = 0;
                if (idx < 0) idx = 0;
                slideIndex = idx;

                const slides = Array.from(canvas.querySelectorAll(".slide"));

                // Hide all other slides and stop their videos
                slides.forEach((s) => {
                    if (parseInt(s.dataset.idx, 10) !== idx) {
                        s.classList.remove("visible");
                        const v = s.querySelector("video");
                        if (v) {
                            v.pause();
                            v.onended = null;
                        }
                    }
                });

                const newSlide = slides.find((s) => parseInt(s.dataset.idx, 10) === idx);
                if (!newSlide) return;

                // Apply transition
                if (p.transition === "cut") {
                    newSlide.style.transition = "none";
                } else {
                    newSlide.style.transition = "opacity 800ms ease";
                }
                void newSlide.offsetWidth;
                newSlide.classList.add("visible");
                currentSlideEl = newSlide;

                const item = p.items[idx];
                const videoEl = newSlide.querySelector("video");

                if (videoEl) {
                    const start = item.start || 0;
                    const end = item.end || null;

                    // Clear previous handlers
                    videoEl.onended = null;
                    videoEl.onloadedmetadata = null;

                    const playFrom = () => {
                        try {
                            if (videoEl.duration && start <= videoEl.duration) {
                                videoEl.currentTime = Math.min(start, videoEl.duration - 0.01);
                            }
                        } catch (e) {
                            /* ignore */
                        }

                        videoEl.play().catch(() => {});

                        if (end && end > start) {
                            // Poll to detect end time
                            const checkEnd = () => {
                                if (!newSlide.classList.contains("visible")) return;
                                if (videoEl.currentTime >= end) {
                                    videoEl.pause();
                                    advanceNow(p);
                                } else {
                                    requestAnimationFrame(checkEnd);
                                }
                            };
                            requestAnimationFrame(checkEnd);
                        } else {
                            // No end specified: advance immediately when video ends
                            videoEl.onended = () => advanceNow(p);
                        }
                    };

                    if (videoEl.readyState >= 1) {
                        playFrom();
                    } else {
                        videoEl.onloadedmetadata = () => playFrom();
                        // Force load in case it's stalled
                        videoEl.load();
                    }
                } else {
                    // Image: wait intervalMs then advance
                    scheduleNext(p);
                }
            }

            // Called after a video finishes — go to next slide with NO extra delay
            function advanceNow(p) {
                clearTimeout(slideTimer);
                slideTimer = null;
                if (p.mode === "single") return;
                const next = (slideIndex + 1) % (p.items.length || 1);
                showSlideAtIndex(p, next);
            }

            // Called after an image — wait the configured interval before advancing
            function scheduleNext(p) {
                clearTimeout(slideTimer);
                slideTimer = null;
                if (p.mode === "single") return;

                const interval = p.intervalMs || 5000;
                slideTimer = setTimeout(() => {
                    const next = (slideIndex + 1) % (p.items.length || 1);
                    showSlideAtIndex(p, next);
                }, interval);
            }

            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === "visible" && presentation) {
                    showSlideAtIndex(presentation, slideIndex);
                }
            });
        </script>
    </body>
</html>
